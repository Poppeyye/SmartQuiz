import{mostrarPinSiDisponible}from"./user-pins.js";import{backgroundMusic,correctSound,wrongSound,welcomeSound,isMuted}from"./mute-handler.js";document.addEventListener("DOMContentLoaded",()=>{let p=document.getElementById("user-name"),$=document.getElementById("pin-code"),t=document.getElementById("username-status"),n=document.getElementById("pin-container"),o=document.getElementById("start-button"),F=document.getElementById("welcome-container"),R=document.getElementById("faq-container"),D=document.getElementById("chart-container"),g=document.getElementById("category-container"),W=document.getElementById("ranking-container"),H=document.getElementById("slogan"),r=document.getElementById("option-button-1"),s=document.getElementById("option-button-2"),l=document.getElementById("timer-text"),h=document.getElementById("result-text"),f=document.getElementById("score-text"),b=document.getElementById("count-text"),z=document.getElementById("best-scores-list"),C=document.getElementById("answer-buttons"),x=document.getElementById("question-text"),E=document.querySelector("#answer-buttons picture img"),i=document.getElementById("question-container"),c=document.getElementById("progress-bar-container"),d=document.getElementById("progress-bar"),m=document.getElementById("memorization-message"),u=null,e=null,a=0,y=[],v="",w=null,k=0,T=0,G,_="",J="";function A(){z.innerHTML="",y.sort((e,t)=>t.score-e.score),y.forEach((e,t)=>{var n=document.createElement("li");0===t?n.innerHTML=`<img src="/${staticFolder}/svgs/gold.svg" alt="Medalla de Oro" width="20" height="20">${e.name}: `+e.score:1===t?n.innerHTML=`<img src="/${staticFolder}/svgs/silver.svg" alt="Medalla de Plata" width="20" height="20">${e.name}: `+e.score:2===t?n.innerHTML=`<img src="/${staticFolder}/svgs/bronze.svg" alt="Medalla de Bronce" width="20" height="20">${e.name}: `+e.score:n.textContent=e.name+": "+e.score,z.appendChild(n)})}function K(){let o=p.value.trim();var e=$.value;4<=o.length?fetch("/set_user_name",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":B("csrf_access_token")},body:JSON.stringify({user_name:o,pin_code:e})}).then(e=>e.ok?e.json():e.json().then(e=>{throw new Error(e.error)})).then(e=>{if(pin_code=e.pin_code,mostrarPinSiDisponible(pin_code),F.style.display="none",R.style.display="none",D.style.display="none",g.style.display="block","New user set"===e.message){document.getElementById("blurBackground").style.display="block";let e=document.getElementById("welcomeMessage"),t=(e.innerText=`Gracias por unirte ${o}! 👩‍💻`,e.style.display="block",setTimeout(()=>{e.style.opacity="1"},50),document.getElementById("pinDisplay")),n=(t.classList.add("flecha"),document.getElementById("infoMessage"));n.style.display="block",n.style.opacity="1",welcomeSound.play(),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>{e.style.display="none",document.getElementById("blurBackground").style.display="none",t.classList.remove("flecha"),n.style.opacity="0",setTimeout(()=>{n.style.display="none"},400)},600)},6e3)}}).catch(e=>{console.error(e),alert(e.message)}):alert("El nombre de usuario debe tener más de 3 caracteres")}async function X(){isMuted||backgroundMusic.play(),S&&(clearInterval(S),w=!1);t=v;var e,t=(e={flags:"/get_country_question",LogicGame:"/get_logic_game/logics",Culture:"/get_logic_game/culture",Memoria:"/get_memory_game",default:"/get_question/"+t})[t]||e.default;try{var n,o,a=await fetch(t);204===a.status?O("Has terminado todas las preguntas"):(n=await a.json()).error?alert(n.error):(o=V[v]||V.default,H.style.display="none",await o(n),l.style.display="flex",f.style.display="flex",b.style.display="flex",d.style.width="100%")}catch(e){console.error("Error fetching question:",e)}}p.addEventListener("input",()=>{userName=p.value.trim(),clearTimeout(G),3<userName.length?G=setTimeout(()=>{var e;4<(e=userName).length&&fetch("/check_user_name",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":B("csrf_access_token")},body:JSON.stringify({user_name:e})}).then(e=>e.json()).then(e=>{e.available?(t.style.color="green",t.style.fontWeight="400",t.textContent="Nombre de usuario disponible",o.disabled=!1,n.style.display="none"):e.no_pin?(t.style.color="white",t.style.fontWeight="400",t.textContent="Introduce el PIN para validar tu identidad",n.style.display="flex"):e.validated?(t.style.color="white",t.style.fontWeight="400",t.textContent="Pin correcto, puedes usar este nombre"):(t.style.color="red",t.textContent="Nombre de usuario no disponible",o.disabled=!0,n.style.display="none")}).catch(e=>{console.error("Error:",e),t.textContent="Error verificando el nombre de usuario",o.disabled=!0,n.style.display="none"})},300):t.textContent=""}),o.addEventListener("click",()=>{K()}),p.addEventListener("keypress",e=>{"Enter"===e.key&&K()}),mostrarPinSiDisponible(pin_code),allCategories.forEach(r=>{var e="category-"+r.toLowerCase(),e=document.getElementById(e);e&&e.addEventListener("click",()=>{{var o=r;v=o,g.style.display="none",768<window.innerWidth&&(async()=>{try{W.style.display="flex",document.querySelector("#ranking-container h2").textContent="Top 7 "+categoryNames[v];var e=await(await fetch("/get_best_scores/"+v)).json();e.scores&&(y=e.scores,A())}catch(e){console.error("Error fetching best scores:",e)}})();let e=document.createElement("p"),t=(e.style.fontSize="4rem",e.style.textAlign="center",e.style.color="rgba(252, 211, 77, 0.8)",i.appendChild(e),i.style.display="block",3);function a(){"Memoria"===v&&(m.innerText="Tienes 6 segundos para memorizar todo lo que veas",m.style.display="block"),e.innerText=3===t?"3...":2===t?"2...":"1..."}a();let n=setInterval(()=>{(0<--t?a:(clearInterval(n),m.style.display="none",i.removeChild(e),X))()},1e3)}})});let I,V={flags:function(e){var{correct_country:e,random_country:t}=e,t=[e,t].sort(()=>Math.random()-.5);E.style.display="inline",E.src=`https://flagcdn.com/160x120/${e.iso_code.toLowerCase()}.png`,r.textContent=t[0].name,s.textContent=t[1].name,u=e.name,C.style.display="flex",c.style.display="flex",P()},LogicGame:function(e){U(e),C.style.display="flex",c.style.display="flex",P()},Culture:function(e){U(e),C.style.display="flex",c.style.display="flex",P()},Memoria:async function(e){var t,n;I=j(e.problem),x.style.display="block",x.textContent=I,C.style.display="none",await new Promise(e=>setTimeout(e,6e3)),t=(e=e).question,n=j(e.wrong),e=j(e.correct),n=(n=[n,e]).sort(()=>Math.random()-.5),r.textContent=n[0],s.textContent=n[1],x.style.display="block",x.textContent=t,i.style.display="block",C.style.display="flex",u=e,C.style.display="flex",c.style.display="flex",_=`ℹ️ Pregunta de memoria: ${t}<br><br>Problema:<br>${I}<br><br>Respuesta correcta:<br>${e} ℹ️`,P()},default:function(o){{let e=o.question,t=j(o.wrong),n=j(o.correct);_=j(o.explanation);var a=(a=[t,n]).sort(()=>Math.random()-.5);r.textContent=a[0],s.textContent=a[1],x.style.display="block","VF"==e&&(e="Elige la afirmación correcta"),x.textContent=e,i.style.display="block",u=n,(a=document.getElementById("created-by-span")).textContent="Pregunta de: "+o.created_by}C.style.display="flex",c.style.display="flex",P()}};function U(e){var t=e.question,n=j(e.wrong),e=j(e.correct),n=[n,e].sort(()=>Math.random()-.5);r.textContent=n[0],s.textContent=n[1],x.style.display="block",x.textContent=t,i.style.display="block",u=e,_=`ℹ️ Pregunta: ${t}<br><br>Respuesta correcta:<br>${e}ℹ️`}let N=0;function B(t){var n=document.cookie.split(";");for(let e=0;e<n.length;e++){var o=n[e].trim();if(o.startsWith(t+"="))return o.substring(t.length+1)}}function Q(){var e=document.getElementById("ranking-container");768<window.innerWidth&&"none"!=e.style.display?e.style.display="flex":e.style.display="none"}window.addEventListener("resize",Q),Q();let Y=10,S,M,L;function P(){M=Date.now(),Z(),S=setInterval(Z,100)}function j(e){e=atob(e),e=new Uint8Array([...e].map(e=>e.charCodeAt(0)));return new TextDecoder("utf-8").decode(e)}function Z(){var e;w||(e=(Date.now()-M)/1e3,e=(L=Y-e)/Y*100,d.style.width=e+"%",l.textContent=`Tiempo: ${L.toFixed(1)}s`,L<=0&&!w&&O("Se acabó el tiempo!\n Puntuación Total: "))}function q(){clearInterval(e),e=null,d.style.transition="none",d.style.width="100%",d.offsetHeight,d.style.transition="width 1s linear",w=!0,l.style.display="none"}function ee(e){if(!w){q();var t=(Date.now()-M)/1e3;if(console.log(t),e===u){correctSound.play();var e=t,n=(n=["Bien!","Excelente!","Sigue así!","Muy bien hecho!","Gran trabajo!","Correcto!","Olé!","Eso es!","Crack!"])[Math.floor(Math.random()*n.length)];{var o=n;let e=document.createElement("div");e.className="popup-message",e.textContent=o,document.body.appendChild(e),e.offsetWidth,setTimeout(()=>{e.classList.add("popup-message-show")},10),setTimeout(()=>{e.classList.remove("popup-message-show"),setTimeout(()=>{document.body.removeChild(e)},300)},1e3)}n=Math.max(0,10-e),a+=n,a=parseFloat(a.toFixed(2)),f.textContent="Puntuación Total: "+a.toFixed(2),k+=1,b.textContent="Correctas: "+k,T+=e,console.log(T),setTimeout(()=>{var t,e,n;768<window.innerWidth&&(t=userName,e=a,-1!==(n=y.findIndex(e=>e.name.toLowerCase()===t.toLowerCase()))?y[n].score=Math.max(y[n].score,e):y.push({name:t,score:e}),y.sort((e,t)=>t.score-e.score),10<y.length&&y.pop(),A()),X()},1300)}else wrongSound.play(),w=!0,O("Incorrecto!\n Puntuación total: ");console.log(`Tiempo de respuesta: ${t.toFixed(2)}s`)}}function O(e){q(),backgroundMusic.currentTime=0,backgroundMusic.pause(),h.textContent=e+": "+a,h.style.opacity=1,c.style.display="none",(async(e,t,n,o)=>{try{if(!(await fetch("/add_score",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":B("csrf_access_token")},body:JSON.stringify({name:e,score:t,category:v,total_correct:o,total_time:n})})).ok)throw new Error("Error al agregar la puntuación")}catch(e){console.error("Error:",e)}})(userName,a,T,k),(async e=>{window.scrollTo(0,0);let t=document.createElement("div"),n=(t.className="final-overlay",await(async e=>{var t=v?"/get_user_rank/"+v:"/get_user_rank/",e=new URLSearchParams({playerScore:e});try{var n=await(await fetch(t+"?"+e)).json();N=n.userRank}catch(e){console.error("Error fetching user rank:",e)}return N})(e)),o=document.createElement("div"),a=(o.className="message-box",document.createElement("p")),r=(a.className="overlay-subtitle",a.textContent=e+" 📣 #"+n,document.createElement("p")),s=(r.className="overlay-username",r.textContent=""+userName,o.appendChild(r),document.createElement("span")),l=(s.className="message-box-label",s.textContent="genias.io",o.appendChild(s),document.createElement("h1")),i=(l.className="overlay-title",document.createElement("p"));i.className="rank-message",3===N?r.textContent=userName+"🥉":2===N?r.textContent=userName+"🥈":1===N&&(r.textContent=userName+"🥇"),(e=document.createElement("p")).className="overlay-category",e.textContent=""+categoryNames[v],o.appendChild(a),o.appendChild(i),o.appendChild(e),t.appendChild(o);(e=document.createElement("div")).className="button-container";var c=document.createElement("button"),d=(c.textContent="Volver a Jugar",c.className="btn",document.createElement("button")),m=(d.textContent="Ver Rankings",d.className="btn",document.createElement("button")),u=(m.textContent="Compartir Resultado",m.className="btn",e.appendChild(c),e.appendChild(d),e.appendChild(m),t.appendChild(e),document.createElement("div")),y=(u.style.marginTop="10px",u.style.display="flex",u.style.justifyContent="center",document.createElement("button"));y.className="report-button",y.textContent="Reportar pregunta",e.appendChild(y),u.appendChild(y),t.appendChild(u),(e=document.createElement("p")).className="info-field",_&&(e.innerHTML=`ℹ️ ${_} ℹ️`),e.style.marginTop="20px",e.style.fontSize="14px",e.style.color="white",e.style.textAlign="center",t.appendChild(e),document.body.appendChild(t),J="flags"==v?E.src:x.textContent,y.addEventListener("click",()=>{var e,t;confirm("¿Estás seguro de que deseas reportar esta pregunta como incorrecta?")&&(e=J,t=v,fetch("/report_question",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":B("csrf_access_token")},body:JSON.stringify({question:e,category:t})}).then(e=>e.json()).then(e=>{alert("Gracias por tu reporte. Revisaremos esta pregunta.")}).catch(e=>{console.error("Error al enviar el reporte:",e)}))}),c.addEventListener("click",()=>{document.body.removeChild(t),fetch("/end_game",{method:"POST"}).then(e=>e.json()).then(e=>{F.style.display="none",g.style.display="block",C.style.display="none",p.value=userName,h.style.display="none",f.style.display="none",b.style.display="none",H.style.display="flex",_="",x.style.display="none",E.style.display="none"})}),d.addEventListener("click",()=>{q(),document.body.removeChild(t),window.location.href="/rankings"}),m.addEventListener("click",async()=>{let t="https://genias.io/rankings?search="+userName;try{(await html2canvas(o)).toBlob(e=>{e=new File([e],"screenshot.png",{type:"image/png"});navigator.canShare&&navigator.canShare({files:[e]})?navigator.share({title:"¡Mira esta clasificación!",text:i.textContent,files:[e],url:t}).then(()=>console.log("Contenido compartido")).catch(e=>console.error("Error al compartir:",e)):alert("Tu dispositivo no soporta compartir esta funcionalidad.")})}catch(e){console.error("Error al capturar el screenshot:",e)}})})(a),a=0,T=0,k=0,b.textContent="Correctas: "+k;e=document.querySelector(".ranking-popup");e&&document.body.removeChild(e)}r.addEventListener("click",()=>{ee(r.textContent)}),s.addEventListener("click",()=>{ee(s.textContent)})});